<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="hugo-academic">
  <meta name="generator" content="Hugo 0.29" />
  <meta name="author" content="Monica Alexander">
  <meta name="description" content="Assistant Professor">

  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    
  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha512-6MXa8B6uaO18Hid6blRMetEIoPqHf7Ux1tnyIQdpt9qI5OACx7C+O3IVTr98vwGnlcg0LOLa02i9Y1HpVhlfiw==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.0/css/academicons.min.css" integrity="sha512-GGGNUPDhnG8LEAEDsjqYIQns+Gu8RBs4j5XGlxl7UfRaZBhCCm5jenJkeJL8uPuOXGqgl8/H1gjlWQDRjd3cUQ==" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw==" crossorigin="anonymous">
  
  
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather%7CRoboto+Mono">
  <link rel="stylesheet" href="/css/hugo-academic.css">
  
  <link rel="stylesheet" href="/css/blue.css">
  

  
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-61981092-1', 'auto');
      ga('require', 'eventTracker');
      ga('require', 'outboundLinkTracker');
      ga('require', 'urlChangeTracker');
      ga('send', 'pageview');
    </script>
    <script async src="//www.google-analytics.com/analytics.js"></script>
    
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js" integrity="sha512-HUmooslVKj4m6OBu0OgzjXXr+QuFYy/k7eLI5jdeEy/F4RSgMn6XRWRGkFi5IFaFgy7uFTkegp3Z0XnJf3Jq+g==" crossorigin="anonymous"></script>
    
  

  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="Monica Alexander">
  <link rel="feed" href="/index.xml" type="application/rss+xml" title="Monica Alexander">

  <link rel="icon" type="image/png" href="/img/icon.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/apple-touch-icon.png">

  <link rel="canonical" href="/2018/09/21/estimating-age-specific-mortality-rates-at-the-subnational-level/">

  

  <title>Estimating age-specific mortality rates at the subnational level | Monica Alexander</title>

</head>
<body id="top" data-spy="scroll" data-target="#navbar-main" data-offset="71">

<nav class="navbar navbar-default navbar-fixed-top" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Monica Alexander</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#publications">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#teaching">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#professional">
            
            <span>Professional</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
          </a>
        </li>

        
        

        
      </ul>

    </div>
  </div>
</nav>


<article class="article" itemscope itemtype="http://schema.org/Article">

  


  <div class="article-container">
    <h1 itemprop="name">Estimating age-specific mortality rates at the subnational level</h1>
    

<div class="article-metadata">

  <span class="article-date">
    <time datetime="2018-09-21 00:00:00 &#43;0000 UTC" itemprop="datePublished">
      21 September 2018
    </time>
  </span>

  

  

  
  

  

</div>

    <div class="article-style" itemprop="articleBody">
      <div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This is a tutorial on estimating age-specific mortality rates at the subnational level, using a model similar to that described in our <a href="https://link.springer.com/article/10.1007/s13524-017-0618-7">Demography paper</a>. There are four main steps, which will be described below:</p>
<ol style="list-style-type: decimal">
<li>Prepare data and get it in the right format</li>
<li>Choose and create a mortality standard</li>
<li>Fit the model</li>
<li>Analyze results from the model</li>
</ol>
<p>A few notes on this particular example:</p>
<ul>
<li>I’ll be fitting the model to county-level mortality rates in California over the years 1999 to 2016. These are age-specific mortality rates for both sexes for the age groups &lt;1, 1-4, 5-9, 10-14, 15-19, 20-24, 25-34, 35-44, 45-54, 55-64, 65-74, 75-84, 85+.</li>
<li>Data on deaths and populations are publicly available through <a href="https://wonder.cdc.gov/">CDC WONDER</a>. However, age groups where death counts are less than 10 are suppressed, and so for some age group/year/county combinations, there are missing data. Also note that there are no observations for any years for two counties, Sierra and Alpine.</li>
<li>All analysis was done in R and the model was fit using JAGS. Other MCMC options such as Stan, WinBUGS or PyMC would probably work just as well.</li>
</ul>
<p>All the code to reproduce this example can be found here: <a href="https://github.com/MJAlexander/states-mortality/tree/master/CA_county_example" class="uri">https://github.com/MJAlexander/states-mortality/tree/master/CA_county_example</a>. Please see the R file <code>CA.R</code> in the <code>code</code> folder.</p>
<p>A note on modeling: there are many adaptions that can be made to this broad model set up, which may be more suitable in different situations. When estimating mortality in your own work, make sure to undergo a suitable validation process to see that the estimates are sensible, and fully test alternatives.</p>
</div>
<div id="preparing-the-data" class="section level1">
<h1>1. Preparing the data</h1>
<p>The first step is to obtain data on death counts and population by age (and potentially sex) groups, and get it in the right format for modeling purposes. Note that you need counts, not just the mortality rates, as inputs into the model.</p>
<p>In this example, I downloaded data on death and population counts by county (the files <code>CA.csv</code> and <code>CA_pop.csv</code> in the data folder). Because these two data sources had different age groups available, I had to a bit of cleaning up to make sure everything was consistent. The resulting deaths data has the following form:</p>
<pre><code>##               county code age_group year deaths   pop age          mx
## 1 Alameda County, CA 6001  &lt; 1 year 1999    110 19336   0 0.005688871
## 2 Alameda County, CA 6001  &lt; 1 year 2000    104 19397   0 0.005361654
## 3 Alameda County, CA 6001  &lt; 1 year 2001    133 22044   0 0.006033388
## 4 Alameda County, CA 6001  &lt; 1 year 2002     91 21316   0 0.004269094
## 5 Alameda County, CA 6001  &lt; 1 year 2003     97 21091   0 0.004599118
## 6 Alameda County, CA 6001  &lt; 1 year 2004    111 20339   0 0.005457495</code></pre>
<p>For the JAGS model, the data has to has to be in the form of an array. The notation used throughout the JAGS model is referring to age <span class="math inline">\(x\)</span>, time <span class="math inline">\(t\)</span>, area <span class="math inline">\(a\)</span> and state <span class="math inline">\(s\)</span>. So both the deaths and population data need to be in the form of an array with dimensions age x time x area x state. I did this in quite an ugly way combining loops and tidyverse, which probably isn’t the most elegant way, but it works :) The resulting deaths data for the first county (Alameda) looks like this:</p>
<pre class="r"><code>#y.xtas[,,1,1]</code></pre>
</div>
<div id="preparing-the-mortality-standard" class="section level1">
<h1>2. Preparing the mortality standard</h1>
<p>The other main inputs to the mortality model are the principal components derived from the mortality standard. Which mortality standard you choose to derive your principal components from depends on your specific problem. In the case of this example, I decided to use state-level mortality schedules for all states in the US over the period 1959–2015. These data are available through the <a href="https://usa.mortality.org/">United States Mortality Database</a>.</p>
<p>The code I used to create the principal components using these data are <a href="https://github.com/MJAlexander/states-mortality/blob/master/CA_county_example/code/pcs.R">here</a>. Again note that for this particular example, I had to alter the data so that the age groups were consistent.</p>
<p>Once the principal components are obtained, they can be input into the model based on being in a matrix with dimension age x component. Note that the model fitted here uses three components. The inputs are below:</p>
<pre><code>##            V1           V2           V3
## 1  0.20853194  0.630214628  0.287652535
## 2  0.35264710  0.300256735 -0.162737410
## 3  0.38660035  0.252316283 -0.287091193
## 4  0.38118755 -0.017848623 -0.403974070
## 5  0.32970586 -0.252356450 -0.352528704
## 6  0.31523511 -0.359905277 -0.025726734
## 7  0.30949609 -0.383953991  0.306658736
## 8  0.28246520 -0.191162991  0.454141280
## 9  0.24350004 -0.003865125  0.401059537
## 10 0.20458378  0.099035872  0.221135219
## 11 0.16646980  0.139019421  0.085803340
## 12 0.12715285  0.116507026  0.052966450
## 13 0.09332889 -0.169677526 -0.004089363</code></pre>
</div>
<div id="running-the-model" class="section level1">
<h1>3. Running the model</h1>
<p>Now that we have the required data inputs, the JAGS model can be run. You need to create an input list of all the data required by JAGS, and specify the names of the parameters you would like to monitor and get posterior samples for.</p>
<pre class="r"><code>jags.data &lt;- list(y.xtas = y.xtas, 
                  pop.xtas = pop.xtas, 
                  Yx = pcs,
                  S = 1, X= length(age_groups), T = length(years), 
                  n.a=length(counties), n.amax=length(counties), P=3 )

parnames &lt;- c(&quot;beta.tas&quot;, &quot;mu.beta&quot; ,&quot;sigma.beta&quot;, &quot;tau.mu&quot;, &quot;u.xtas&quot;, &quot;mx.xtas&quot;)</code></pre>
<p>Once that is done, the model can be run. Please look at the model text file in reference to the paper to see which variables refer to what aspects. The notation used in the JAGS model is (I hope) fairly consistent with the notation in the paper.</p>
<pre class="r"><code>mod &lt;- jags(data = jags.data, 
            parameters.to.save=parnames, 
            n.iter = 30000,
            model.file = &quot;../code/model.txt&quot;)</code></pre>
<p>This may take a while to run, so be patient. You can look at a summary of the model estimates like this:</p>
<pre class="r"><code>mod$BUGSoutput$summary</code></pre>
<p>Note that the values of all Rhats should be less than 1.1, otherwise the estimates are unreliable and should not be interpreted. If you have Rhats that are greater than 1.1, try running the model for more iterations.</p>
<pre class="r"><code># check all Rhats are less than 1.1
max(mod$BUGSoutput$summary[,&quot;Rhat&quot;])</code></pre>
</div>
<div id="extract-results" class="section level1">
<h1>4. Extract results</h1>
<p>Now that we have model estimates, we need to be able to extract them and look at the results. You can get the posterior samples for all parameters by extracting the <code>sims.array</code> from the model object:</p>
<pre class="r"><code>mcmc.array &lt;- mod$BUGSoutput$sims.array</code></pre>
<p>Unless you’re interested in the underlying mechanics of the model, you’re probably most interested in the estimates for the age-specific mortality rates, <code>mx.xtas</code>. The <code>sims.array</code> has dimensions number iterations (default 1,000) x number of chains (default 3) x number of parameters. So to look at the posterior samples for <code>mx.xtas[1,1,1,1]</code> for example, you would type:</p>
<pre class="r"><code>mcmc.array[,,&quot;mx.xtas[1,1,1,1]&quot;]</code></pre>
<p>Once the posterior samples are obtained, these are used to obtain the best estimate of the parameter (usually the median) and Bayesian credible intervals. For example, a 95% credible interval can be calculated by getting the 2.5th and 97.5th quantile of the posterior samples. Below is a chart that illustrates some of the age-specific mortality estimates for six Californian counties in 2016. Code to generate this chart is included in <code>CA.R</code>.</p>
<div class="figure">
<img src="/img/select_counties_mx.png" width="800" />

</div>
<p>Once the estimate for mortality rates are extracted, you can also convert these into other mortality measures, such as life expectancy, using standard life table relationships. The code on GitHub includes a function which derives life expectancy from the mx’s, called <code>derive_ex_values</code>. This function is loaded in at the beginning of the <code>CA.R</code>. Code to generate this chart is included at the end of <code>CA.R</code>.</p>
<div class="figure">
<img src="/img/e0_alameda.png" width="600" />

</div>
</div>
<div id="summary" class="section level1">
<h1>Summary</h1>
<p>This document gives a brief introduction into the practicalities of fitting a Bayesian subnational mortality model in R using JAGS. There are many different layers to the model and assumptions associated with it, so it is recommended that the user of this code and model is familiar with <a href="https://link.springer.com/article/10.1007/s13524-017-0618-7">the paper</a> and the assumptions outlined in it. Good luck! :)</p>
</div>

    </div>
  </div>

</article>

<div class="container">
  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="/2018/06/04/thoughts-after-finishing-a-demography-phd/"><span
      aria-hidden="true">&larr;</span> Thoughts after finishing a Demography PhD</a></li>
    

    
  </ul>
</nav>

</div>

<div class="article-container">
  

</div>

<footer class="site-footer">
  <div class="container">
    <p class="powered-by">

      &copy; 2018 Monica Alexander &middot; 

      Powered by the <a href="https://github.com/gcushen/hugo-academic" target="_blank">Academic
      theme</a> for <a href="http://gohugo.io" target="_blank">Hugo</a>.

      <span class="pull-right" aria-hidden="true">
        <a href="#" id="back_to_top">
          <span class="button_icon">
            <i class="fa fa-chevron-up fa-2x"></i>
          </span>
        </a>
      </span>

    </p>
  </div>
</footer>

    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha512-jGsMH83oKe9asCpkOVkBnUrDDTp8wl+adkB2D+//JtlxO4SrLoJdhbOysIFQJloQFD+C4Fl1rMsQZF76JjV0eQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.2/imagesloaded.pkgd.min.js" integrity="sha512-iHzEu7GbSc705hE2skyH6/AlTpOfBmkx7nUqTLGzPYR+C1tRaItbRlJ7hT/D3YQ9SV0fqLKzp4XY9wKulTBGTw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenMax.min.js" integrity="sha512-Z5heTz36xTemt1TbtbfXtTq5lMfYnOkXM2/eWcTTiLU01+Sw4ku1i7vScDc8fWhrP2abz9GQzgKH5NGBLoYlAw==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/plugins/ScrollToPlugin.min.js" integrity="sha512-CDeU7pRtkPX6XJtF/gcFWlEwyaX7mcAp5sO3VIu/ylsdR74wEw4wmBpD5yYTrmMAiAboi9thyBUr1vXRPA7t0Q==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha512-iztkobsvnjKfAtTNdHkGVjAYTrrtlC7mGp/54c40wowO7LhURYl3gVzzcEqGl/qKXQltJ2HwMrdLcNUdo+N/RQ==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.4/isotope.pkgd.min.js" integrity="sha512-VDBOIlDbuC4VWxGJNmuFRQ0Li0SKkDpmGyuhAG5LTDLd/dJ/S0WMVxriR2Y+CyPL5gzjpN4f/6iqWVBJlht0tQ==" crossorigin="anonymous"></script>
    
    <script src="/js/hugo-academic.js"></script>
    

    
    
      
      <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML" integrity="sha512-tOav5w1OjvsSJzePRtt2uQPFwBoHt1VZcUq8l8nm5284LEKE9FSJBQryzMBzHxY5P0zRdNqEcpLIRVYFNgu1jw==" crossorigin="anonymous"></script>
    
    

  </body>
</html>

